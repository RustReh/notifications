# Сервис Уведомлений (Notification Service)

Асинхронный микросервис для отправки уведомлений через различные каналы (Email, SMS, Telegram) с механизмом автоматического переключения (fallback) при ошибках.

## Описание

Сервис слушает очередь RabbitMQ, обрабатывает входящие сообщения с запросами на уведомления и отправляет их через доступные и настроенные каналы связи в порядке приоритета, указанном в запросе.

## Архитектура

- **RabbitMQ**: Используется как брокер сообщений.
- **Consumer**: Асинхронно получает сообщения из очереди `notifications.main`.
- **Gateway**: `NotificationGateway` управляет зарегистрированными сервисами уведомлений и реализует логику fallback.
- **Сервисы**: `EmailService`, `SMSService`, `TelegramService` реализуют конкретную логику отправки.
- **Dead Letter Queue (DLQ)**: Неудачные сообщения перенаправляются в `notifications.dlq` после истечения TTL или ручного `nack(requeue=False)`.

## Функциональность

- Асинхронная обработка сообщений.
- Отправка уведомлений по Email, SMS и Telegram.
- Настраиваемый порядок приоритета каналов для каждого запроса.
- Автоматический fallback на резервные каналы при ошибке.
- Валидация входящих сообщений.
- Обработка ошибок и логирование.
- Использование Dead Letter Exchange/Queue для недоставленных сообщений.

## Требования

- Python 3.12+
- Docker & Docker Compose (для запуска с зависимостями)
- Доступ к RabbitMQ
- Доступ к SMTP серверу (для Email)
- Доступ к API провайдеров SMS/Telegram (для соответствующих сервисов)

## Установка и запуск

### Используя Docker Compose (рекомендуется)

1.  Убедитесь, что у вас установлен Docker и Docker Compose.
2.  Создайте файл `.env` в корне проекта с необходимыми переменными окружения (см. ниже).
3.  Выполните команду:

    ```bash
    docker-compose up --build
    ```

### Локальный запуск

1.  Установите зависимости с помощью Poetry:

    ```bash
    poetry install
    ```

2.  Создайте файл `.env` с переменными окружения.
3.  Запустите сервис:

    ```bash
    poetry run python -m src/main.py
    ```

## Конфигурация

Сервис конфигурируется через переменные окружения:

| Переменная         | Описание                       | Значение по умолчанию     |
| :----------------- | :----------------------------- | :------------------------ |
| `DEBUG`            | Режим отладки                  | `True`                    |
| `RABBIT_USER`      | Имя пользователя RabbitMQ      | `guest`                   |
| `RABBIT_PASS`      | Пароль пользователя RabbitMQ   | `guest`                   |
| `RABBIT_SERVER`    | Адрес сервера RabbitMQ         | `localhost:5672`          |
| `SMTP_SERVER`      | SMTP сервер для Email          | *(необходимо указать)*    |
| `SMTP_PORT`        | Порт SMTP сервера              | *(необходимо указать)*    |
| `EMAIL_USER`       | Имя пользователя SMTP          | *(необходимо указать)*    |
| `EMAIL_PASS`       | Пароль SMTP                    | *(необходимо указать)*    |
| `SMS_API_KEY`      | API ключ для SMS сервиса       | *(необходимо указать)*    |
| `TELEGRAM_BOT_TOKEN`| Токен Telegram бота           | *(необходимо указать)*    |
